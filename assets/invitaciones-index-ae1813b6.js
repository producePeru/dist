import{r as _,a as V,G as q,k as oe,b as i,o as B,d as G,c as a,e as f,w as l,h as s,m as D,j as b,y as se,z as H,t as R,K as re}from"./index-1ff16546.js";import{r as ie,u as ue}from"./xlsx-04f2268f.js";import{_ as de}from"./_plugin-vue_export-helper-c27b6911.js";const ce={class:"containers"},me={class:"grid grid-cols-3"},pe={class:"p-box bg-light border rounded"},ve={class:"text-small"},fe=["srcdoc"],_e={__name:"invitaciones-index",setup(be){const u=_(null),d=V({name:"",content:""}),k=_([]),Z=[{title:"Nombre",dataIndex:"name",key:"name"},{title:"Acciones",dataIndex:"actions",key:"actions"}],w=_(!1),h=()=>{w.value=!0},K=async()=>{if(!d.name||!d.content)return s.error("Complete todos los campos");const t={name:d.name,content:d.content};try{const e=await D({url:"email/create-email-templates",method:"POST",data:t});e.status==200&&(s.success(e.message),d.name="",d.content="",w.value=!1)}catch{s.error("Error al guardar la plantilla")}},C=_(!1),c=V({id:"",name:"",content:""});function Y(t){c.id=t.id,c.name=t.name,c.content=t.content,C.value=!0}function J(){const t=u.value.findIndex(e=>e.id===c.id);t>=0&&(u.value[t].name=c.name,u.value[t].content=c.content,k.value=u.value.map(e=>({label:e.name,value:e.id})),s.success("Plantilla actualizada")),C.value=!1}function Q(t){u.value=u.value.filter(e=>e.id!==t),k.value=u.value.map(e=>({label:e.name,value:e.id})),s.success("Plantilla eliminada")}const r=V({templateId:"",subject:"",cc:"",bcc:""}),E=_([]),$=_([]),I=/^(?:[a-zA-Z0-9_'^&%+\-]+(?:\.[a-zA-Z0-9_'^&%+\-]+)*)@(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}$/,A=q(()=>E.value.filter(t=>I.test(t))),W=async t=>{var j;const e=["xls","xlsx"],g=(j=t.name.split(".").pop())==null?void 0:j.toLowerCase();if(!e.includes(g||""))return s.error("Por favor, sube un archivo Excel válido (.xls o .xlsx)."),!1;const o=new FileReader;return o.onload=L=>{const N=new Uint8Array(L.target.result),x=ie(N,{type:"array"}),O=x.Sheets[x.SheetNames[0]];let m=ue.sheet_to_json(O).map(v=>{const U=Object.keys(v);let y="";for(const n of U){const z=n.toLowerCase();if(["email","correo","mail"].includes(z)){y=String(v[n]).trim();break}}return y}).filter(v=>!!v);const M=m.length;m.length>300&&(s.warning(`Se cargaron solo los primeros 300 correos de un total de ${M}.`),m=m.slice(0,300)),E.value=m,$.value=m.filter(v=>!I.test(v)),s.success(`Correos cargados: ${E.value.length}`)},o.readAsArrayBuffer(t),!1},S=_(!1),P=_(""),T=_(!1),F=q(()=>!!r.templateId),X=q(()=>F.value&&A.value.length>0&&!T.value);function ee(){const t=u.value.find(e=>e.id===r.templateId);if(!t)return s.error("Selecciona una plantilla");P.value=t.content,S.value=!0}async function ae(){const t=u.value.find(e=>e.id===r.templateId);if(!t)return s.error("Selecciona una plantilla");T.value=!0;try{const e=r.cc.split(",").map(o=>o.trim()).filter(o=>I.test(o)),g=r.bcc.split(",").map(o=>o.trim()).filter(o=>I.test(o));await re.post("/api/email/send-bulk",{subject:r.subject,html:t.content,recipients:A.value,cc:e,bcc:g}),s.success("Correos enviados correctamente")}catch{s.error("Error al enviar correos")}finally{T.value=!1}}const te=async()=>{try{const t=await D({url:"email/list-email-templates",method:"GET"});t.status==200&&(u.value=t.data)}catch{s.error("Error al cargar las plantillas")}},le=async()=>{try{const t=await D({url:"email/show-list-email-templates",method:"GET"});t.status==200&&(k.value=t.data)}catch{s.error("Error al cargar las plantillas")}};return oe(async()=>{await te(),await le()}),(t,e)=>{const g=i("a-page-header"),o=i("a-button"),j=i("a-popconfirm"),L=i("a-space"),N=i("a-table"),x=i("a-card"),O=i("a-select"),p=i("a-form-item"),m=i("a-input"),M=i("a-upload"),v=i("a-form"),U=i("a-textarea"),y=i("a-modal");return B(),G("div",ce,[a(g,{title:"Campaña MYPE","sub-title":"Gestor de plantillas y envío de correos",style:{padding:"0","margin-bottom":"1rem"}}),f("div",me,[a(x,{title:"Plantillas guardadas",class:"col-span-1"},{extra:l(()=>[a(o,{type:"primary",onClick:h},{default:l(()=>e[11]||(e[11]=[b("Crear plantilla")])),_:1})]),default:l(()=>[a(N,{"data-source":u.value,columns:Z,"row-key":"id",bordered:"",size:"small"},{bodyCell:l(({column:n,record:z})=>[n.dataIndex==="actions"?(B(),se(L,{key:0},{default:l(()=>[a(o,{size:"small",onClick:ne=>Y(z)},{default:l(()=>e[12]||(e[12]=[b("Editar")])),_:2},1032,["onClick"]),a(j,{title:"¿Eliminar esta plantilla?",onConfirm:ne=>Q(z.id)},{default:l(()=>[a(o,{size:"small",danger:""},{default:l(()=>e[13]||(e[13]=[b("Eliminar")])),_:1})]),_:2},1032,["onConfirm"])]),_:2},1024)):H("",!0)]),_:1},8,["data-source"])]),_:1}),a(x,{title:"Enviar correos",class:"col-span-2"},{default:l(()=>[a(v,{layout:"vertical",model:r,onFinish:ae},{default:l(()=>[a(p,{label:"Plantilla",name:"templateId",rules:[{required:!0,message:"Seleccione una plantilla"}]},{default:l(()=>[a(O,{value:r.templateId,"onUpdate:value":e[0]||(e[0]=n=>r.templateId=n),options:k.value},null,8,["value","options"])]),_:1}),a(p,{label:"Asunto",name:"subject",rules:[{required:!0,message:"Ingrese un asunto"}]},{default:l(()=>[a(m,{value:r.subject,"onUpdate:value":e[1]||(e[1]=n=>r.subject=n)},null,8,["value"])]),_:1}),a(p,{label:"Con copia a"},{default:l(()=>[a(m,{value:r.cc,"onUpdate:value":e[2]||(e[2]=n=>r.cc=n),placeholder:"ejemplo1@correo.com, ejemplo2@correo.com"},null,8,["value"]),e[14]||(e[14]=f("div",{class:"text-small muted"},"Separar correos con coma",-1))]),_:1}),a(p,{label:"Subir lista de correos (.xlsx)"},{default:l(()=>[a(M,{"before-upload":W,"show-upload-list":!1,accept:".xls,.xlsx"},{default:l(()=>[a(o,null,{default:l(()=>e[15]||(e[15]=[b("Subir archivo")])),_:1})]),_:1}),e[16]||(e[16]=f("div",{class:"text-small muted"},[b("Máximo 300 correos. Columna: "),f("b",null,"email")],-1))]),_:1}),f("div",pe,[e[17]||(e[17]=f("div",{class:"font-medium"},"Resumen de correos:",-1)),f("ul",ve,[f("li",null,"Total cargados: "+R(E.value.length),1),f("li",null,"Válidos: "+R(A.value.length),1),f("li",null,"Inválidos: "+R($.value.length),1)])]),a(p,null,{default:l(()=>[a(o,{type:"default",onClick:ee,disabled:!F.value},{default:l(()=>e[18]||(e[18]=[b("Previsualizar")])),_:1},8,["disabled"]),a(o,{type:"primary","html-type":"submit",class:"ml",disabled:!X.value,style:{"margin-left":"1rem"},loading:T.value},{default:l(()=>e[19]||(e[19]=[b("ENVIAR")])),_:1},8,["disabled","loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),a(y,{open:w.value,"onUpdate:open":e[5]||(e[5]=n=>w.value=n),title:"Crear plantilla",onOk:K},{default:l(()=>[a(v,{layout:"vertical",model:d},{default:l(()=>[a(p,{label:"Nombre de la plantilla",name:"name",rules:[{required:!0,message:"Ingrese un nombre"}]},{default:l(()=>[a(m,{value:d.name,"onUpdate:value":e[3]||(e[3]=n=>d.name=n)},null,8,["value"])]),_:1}),a(p,{label:"Contenido (HTML)",name:"content",rules:[{required:!0,message:"Ingrese contenido HTML"}]},{default:l(()=>[a(U,{value:d.content,"onUpdate:value":e[4]||(e[4]=n=>d.content=n),rows:16},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"]),a(y,{open:C.value,"onUpdate:open":e[8]||(e[8]=n=>C.value=n),title:"Editar plantilla",onOk:J},{default:l(()=>[a(v,{layout:"vertical",model:c},{default:l(()=>[a(p,{label:"Nombre"},{default:l(()=>[a(m,{value:c.name,"onUpdate:value":e[6]||(e[6]=n=>c.name=n)},null,8,["value"])]),_:1}),a(p,{label:"Contenido HTML"},{default:l(()=>[a(U,{value:c.content,"onUpdate:value":e[7]||(e[7]=n=>c.content=n),rows:16},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"]),a(y,{open:S.value,"onUpdate:open":e[9]||(e[9]=n=>S.value=n),title:"Previsualización",width:820,onOk:e[10]||(e[10]=()=>S.value=!1)},{default:l(()=>[P.value?(B(),G("iframe",{key:0,srcdoc:P.value,class:"preview-frame"},null,8,fe)):H("",!0)]),_:1},8,["open"])])}}},ke=de(_e,[["__scopeId","data-v-c6d04a1b"]]);export{ke as default};
